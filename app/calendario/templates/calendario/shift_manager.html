{% extends 'base.html' %}
{% block content %}
<style>
  .employee-box {
    cursor: pointer; padding: 5px 8px; margin: 2px;
    border: 1px solid #ccc; display: inline-block; 
    border-radius: 4px; transition: background-color 0.2s ease-in-out;
  }
  .emp-selected {
    background-color: #aaddff; font-weight: bold; border-color: #007bff;
  }
  .assignments span.assigned {
    display: block; margin-bottom: 3px; padding: 3px 5px;
    background-color: #e9ecef; border-radius: 3px; font-size: 0.9em;
    cursor: pointer; /* Make assigned spans also look clickable for removal */
  }
  .shift-cell {
    vertical-align: top; /* Align content to the top */
    min-height: 80px; /* Ensure a minimum height for cells */
  }
  .violation-icons {
    text-align: right; font-size: 0.9em; min-height: 1.2em; /* Adjusted for visibility */
    margin-top: 3px;
  }
  .violation-icon {
    display: inline-block;
    padding: 1px 4px;
    margin-left: 2px;
    border-radius: 3px;
    font-weight: bold;
    color: white;
    cursor: pointer;
  }
  .violation-icon.type-max_consecutive_days { background-color: #dc3545; /* Red */ }
  .violation-icon.type-min_staff_per_day { background-color: #ffc107; color: #333; /* Amber */ }
  .violation-icon.type-forbidden_pair { background-color: #fd7e14; /* Orange */ }
  .violation-icon.type-required_pair { background-color: #6f42c1; /* Indigo */ }
  .violation-icon.type-required_attribute_count { background-color: #0dcaf0; /* Info/Teal */ }
  .violation-icon.type-placeholder_violation { background-color: #6c757d; /* Secondary/Grey */ }
</style>

<h1>{{ month.strftime('%Y-%m') }} シフト管理</h1>
<div>
    {% if nav_prev_month %}
        <a href="{{ url_for('calendario.shift', month=nav_prev_month.strftime('%Y-%m')) }}">&lt; 前月</a>
    {% else %}
        <span class="text-muted">&lt; 前月</span>
    {% endif %}
    | <a href="{{ url_for('calendario.shift') }}">今月</a> |
    {% if nav_next_month %}
        <a href="{{ url_for('calendario.shift', month=nav_next_month.strftime('%Y-%m')) }}">次月 &gt;</a>
    {% else %}
        <span class="text-muted">次月 &gt;</span>
    {% endif %}
</div>
<div class="shift-users my-3">
    <strong>従業員リスト (ドラッグ＆ドロップまたはクリックでセルに追加):</strong><br>
    {% for emp in employees %}
        <div class="employee-box" draggable="true" data-emp="{{ emp }}">{{ emp }}</div>
    {% endfor %}
</div>

<div class="employee-stats-summary card mb-3">
    <div class="card-header">今月の集計</div>
    <div class="card-body" data-current-month="{{ month.strftime('%Y-%m') }}">
        {% if employees %}
            {% for emp in employees %}
                <p style="margin: 5px 0;">
                    {{ emp }}:
                    勤務日数 <span class="work-count" data-emp="{{ emp }}">{{ counts.get(emp, 0) }}</span>日,
                    休日数 <span class="off-count" data-emp="{{ emp }}">{{ off_counts.get(emp, 0) }}</span>日
                </p>
            {% endfor %}
        {% else %}
            <p>表示する従業員がいません。</p>
        {% endif %}
    </div>
</div>

<form method="post">
    {{ form.hidden_tag() }} {# Replaced csrf_token() with Flask-WTF form hidden_tag #}
    <input type="hidden" name="action" value="complete" id="action-field">
    <table class="calendar table table-bordered">
        <thead class="table-light">
            <tr>
                <th>月</th><th>火</th><th>水</th><th>木</th><th>金</th><th>土</th><th>日</th>
            </tr>
        </thead>
        <tbody>
        {% for week in weeks %}
            <tr>
            {% for d in week %}
                <td class="{% if d.month != month.month %}other-month text-muted{% else %}shift-cell{% endif %}" 
                    data-date="{{ d.isoformat() }}" 
                    style="{% if d.month != month.month %}background-color: #f8f9fa;{% endif %}">
                    <div class="day-number">{{ d.day }}</div>
                    <div class="violation-icons"></div> {# Container for violation icons #}
                    <div class="assignments">
                        {% for emp in assignments.get(d.isoformat(), []) %}
                            <span class="assigned">{{ emp }}</span>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="d-{{ d.isoformat() }}" value="{{ ','.join(assignments.get(d.isoformat(), [])) }}">
                </td>
            {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <div class="mt-3">
        <button type="submit" class="btn btn-success" onclick="document.getElementById('action-field').value='complete'">保存</button>
        <button type="submit" class="btn btn-info" onclick="document.getElementById('action-field').value='notify'">保存して通知</button>
        <button type="button" class="btn btn-warning" id="checkViolationsBtn">ルールチェック</button> {# Added button #}
    </div>
</form>
<p class="mt-3"><a href="{{ url_for('calendario.shift_rules') }}" class="btn btn-secondary btn-sm">シフト計算詳細設定</a></p>
<p><a href="{{ url_for('calendario.index', month=month.strftime('%Y-%m')) }}" class="btn btn-outline-secondary btn-sm">カレンダービューに戻る</a></p>

{# Modal for Violation Details #}
<div class="modal fade" id="violationDetailModal" tabindex="-1" aria-labelledby="violationDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="violationDetailModalTitle">違反詳細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="violationDetailModalBody">
        {# Violation details will be populated here by JavaScript #}
        <p>詳細情報を読み込み中...</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>

{# Embed rules data for JavaScript #}
<script>
  window.shiftRules = {{ rules_for_js|tojson|safe }};
  if (typeof window.shiftRules === 'undefined' || window.shiftRules === null) {
    window.shiftRules = { rules: {}, defined_attributes: [] }; // Fallback
    console.warn("Shift rules data not loaded into window.shiftRules from template.");
  }
</script>
<script src="{{ url_for('static', filename='js/shift_manager.js') }}" defer></script>
{% endblock %}
