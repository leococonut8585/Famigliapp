{% extends 'base.html' %}
{% from 'macros.html' import format_datetime_field %}

{% block title %}カレンダー - {{ month.strftime('%Y-%m') }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>{{ month.strftime('%Y-%m') }}</h1>
        <div>
            {% if nav_prev_month %}
                <a href="{{ url_for('calendario.index', month=nav_prev_month.strftime('%Y-%m')) }}" class="btn btn-outline-secondary btn-sm">&lt; 前月</a>
            {% else %}
                <button class="btn btn-outline-secondary btn-sm" disabled>&lt; 前月</button>
            {% endif %}
            <a href="{{ url_for('calendario.index') }}" class="btn btn-outline-secondary btn-sm">今月</a>
            {% if nav_next_month %}
                <a href="{{ url_for('calendario.index', month=nav_next_month.strftime('%Y-%m')) }}" class="btn btn-outline-secondary btn-sm">次月 &gt;</a>
            {% else %}
                <button class="btn btn-outline-secondary btn-sm" disabled>次月 &gt;</button>
            {% endif %}
            <a href="{{ url_for('calendario.index', view='week', week=(month - timedelta(days=month.weekday())).isoformat()) }}" class="btn btn-outline-info btn-sm">週表示</a>
        </div>
    </div>

    <table class="calendar table table-bordered" style="table-layout: fixed;">
        <thead class="table-light">
            <tr>
                <th style="width: 14.28%;">月</th>
                <th style="width: 14.28%;">火</th>
                <th style="width: 14.28%;">水</th>
                <th style="width: 14.28%;">木</th>
                <th style="width: 14.28%;">金</th>
                <th style="width: 14.28%;">土</th>
                <th style="width: 14.28%;">日</th>
            </tr>
        </thead>
        <tbody>
        {% for week in weeks %}
            <tr>
                {% for d in week %}
                <td class="{% if d.month != month.month %}other-month text-muted bg-light{% else %}calendar-day{% endif %}"
                    {% if d.month == month.month %}data-date="{{ d.isoformat() }}"{% endif %}
                    style="vertical-align: top; height: 120px; overflow-y: auto; padding: 2px;"> {# Reduced padding for more space #}
                    <div class="day-number fw-bold" style="font-size: 0.9em; margin-bottom: 2px;">{{ d.day }}</div>

                    {# Removed the all-encompassing event-grid-container #}
                    {% set events_for_day = events_by_date.get(d.isoformat(), []) %}
                    {% for ev in events_for_day %}
                        {# Logic to open shift-grid-container #}
                        {% if ev.category == 'shift' and (loop.first or loop.previtem.category != 'shift') %}
                        <div class="shift-grid-container mt-1">
                        {% endif %}

                        {% if ev.category == 'shift' %}
                            <div class="shift-grid-item event-shift-item calendar-event-text-compact d-flex align-items-center justify-content-between" draggable="true" data-event-id="{{ ev.id }}">
                                <span class="flex-grow-1" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    {{ ev.cleaned_title or ev.employee }}
                                </span>
                                <div class="event-actions" style="white-space: nowrap;">
                                    {% if ev.category != 'shift' %}
                                    <button type="button" class="btn btn-secondary btn-xs-custom ms-1 details-btn"
                                            data-event-id="{{ ev.id }}" data-title="{{ ev.cleaned_title or ev.employee }}"
                                            data-time="{{ ev.display_time or '' }}" data-description="{{ ev.description or '' }}"
                                            data-participants="{{ ev.participants|join(', ') if ev.participants else '' }}"
                                            data-category="{{ ev.category }}">詳細</button>
                                    {% endif %}
                                    <a href="{{ url_for('calendario.edit_event', event_id=ev.id) }}" class="btn btn-custom-edit ms-1">編集</a>
                                </div>
                            </div>
                        {% else %} {# Non-shift events #}
                            <div class="event-grid-item {{ 'event-' + (ev.category if ev.category else 'other') }} calendar-event-text-compact d-flex align-items-center justify-content-between mb-1" draggable="true" data-event-id="{{ ev.id }}">
                                <span class="flex-grow-1" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    {% if ev.time %}<span class="event-time">{{ ev.time }}</span>&nbsp;{% elif ev.display_time %}<span class="event-time">{{ ev.display_time }}</span>&nbsp;{% endif %}
                                    <span class="event-title">{{ ev.cleaned_title }}</span>
                                </span>
                                <div class="event-actions" style="white-space: nowrap;">
                                    <button type="button" class="btn btn-secondary btn-xs-custom ms-1 details-btn"
                                            data-event-id="{{ ev.id }}" data-title="{{ ev.cleaned_title }}"
                                            data-time="{{ ev.time or ev.display_time or '' }}" data-description="{{ ev.description or '' }}"
                                            data-participants="{{ ev.participants|join(', ') if ev.participants else '' }}"
                                            data-category="{{ ev.category }}">詳細</button>
                                    <a href="{{ url_for('calendario.edit_event', event_id=ev.id) }}" class="btn btn-custom-edit ms-1">編集</a>
                                </div>
                            </div>
                        {% endif %}

                        {# Logic to close shift-grid-container #}
                        {% if ev.category == 'shift' and (loop.last or loop.nextitem.category != 'shift') %}
                        </div> {# Close shift-grid-container #}
                        {% endif %}
                    {% endfor %}
                </td>
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <div class="mt-3">
        <a href="{{ url_for('calendario.add') }}" class="btn btn-success">新しい予定を追加</a>
        {% if user.role == 'admin' %}
        <a href="{{ url_for('calendario.shift') }}" class="btn btn-info">シフト管理エリア</a>
        <a href="{{ url_for('calendario.shift_rules') }}" class="btn btn-secondary">シフト計算ルール設定</a>
        {% endif %}
    </div>
    <p class="mt-3"><a href="{{ url_for('index') }}" class="btn btn-outline-secondary">メインページに戻る</a></p>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventDetailModal" tabindex="-1" aria-labelledby="eventDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventDetailModalTitle">予定の詳細</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="eventDetailModalBody">
        <p>詳細を読み込み中...</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/calendar_event_details.js') }}" defer></script>

<div id="dndConfirmationPopup" style="display: none; position: absolute; border: 1px solid #ccc; background-color: white; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1001;">
    <p style="margin-top: 0; margin-bottom: 10px;">この予定に対する操作を選択してください:</p>
    <div style="display: flex; justify-content: space-around;">
        <button type="button" id="dndConfirmMove" class="btn btn-primary btn-sm">移動</button>
        <button type="button" id="dndConfirmCopy" class="btn btn-success btn-sm">コピー</button>
        <button type="button" id="dndConfirmCancel" class="btn btn-secondary btn-sm">キャンセル</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let draggedElement = null;
    let currentDropZone = null;
    let isOperationInProgress = false; // Flag to prevent concurrent operations

    const dndPopup = document.getElementById('dndConfirmationPopup');
    const btnMove = document.getElementById('dndConfirmMove');
    const btnCopy = document.getElementById('dndConfirmCopy');
    const btnCancel = document.getElementById('dndConfirmCancel');

    function clearDragState() {
        if (draggedElement) {
            draggedElement.style.opacity = '1';
        }
        draggedElement = null;
        currentDropZone = null;
        // Clear dataset from popup as well to prevent stale data issues
        if (dndPopup) { // Ensure dndPopup exists
            dndPopup.dataset.eventId = ''; // Clear data from popup
            dndPopup.dataset.newDate = '';
            // dndPopup.style.display = 'none'; // Hide popup if not already hidden by caller
        }
        isOperationInProgress = false; // Reset operation flag
        console.log("Drag state cleared. isOperationInProgress:", isOperationInProgress);
    }

    function addDragEventListeners(item) {
        item.addEventListener('dragstart', function(event) {
            if (isOperationInProgress) { // Prevent starting a new drag if an operation is pending (e.g. popup visible)
                event.preventDefault();
                console.log("Dragstart prevented: operation in progress.");
                return;
            }
            draggedElement = event.target; // Keep track of the currently dragged element
            event.dataTransfer.setData('text/plain', event.target.dataset.eventId);
            setTimeout(() => {
                if(draggedElement) draggedElement.style.opacity = '0.5';
            }, 0);
        });

        item.addEventListener('dragend', function(event) {
            if (dndPopup.style.display === 'none' && !isOperationInProgress) {
                clearDragState();
            }
        });
    }

    const draggableItems = document.querySelectorAll('.event-grid-item, .shift-grid-item');
    draggableItems.forEach(addDragEventListeners);

    const dropTargets = document.querySelectorAll('td.calendar-day');
    dropTargets.forEach(target => {
        target.addEventListener('dragover', function(event) {
            event.preventDefault();
            target.style.backgroundColor = 'rgba(0,0,0,0.1)';
        });
        target.addEventListener('dragleave', function(event) {
            target.style.backgroundColor = '';
        });
        target.addEventListener('drop', function(event) {
            event.preventDefault();
            target.style.backgroundColor = '';

            if (isOperationInProgress) {
                console.log("Drop ignored: operation already in progress.");
                // Optionally, reset draggedElement's opacity if it was made semi-transparent
                if (draggedElement) draggedElement.style.opacity = '1';
                draggedElement = null; // Clear to prevent unintended state
                return;
            }

            if (event.target === draggedElement || (draggedElement && event.target.contains(draggedElement)) || (draggedElement && event.target === draggedElement.parentElement)) {
                if (draggedElement) draggedElement.style.opacity = '1';
                draggedElement = null;
                return;
            }

            currentDropZone = event.currentTarget;
            const eventIdStr = event.dataTransfer.getData('text/plain');
            const newDateStr = currentDropZone.dataset.date;

            if (!eventIdStr || !newDateStr || !draggedElement) {
                console.error('Drop event failed: missing eventId, newDate, or draggedElement was not set.');
                clearDragState();
                return;
            }

            dndPopup.dataset.eventId = eventIdStr;
            dndPopup.dataset.newDate = newDateStr;

            dndPopup.style.left = event.pageX + 'px';
            dndPopup.style.top = event.pageY + 'px';
            dndPopup.style.display = 'block';
        });
    });

    // Event listeners for popup buttons are set only once
    btnMove.addEventListener('click', function() {
        if (isOperationInProgress) {
            console.log("Move operation already in progress.");
            return;
        }
        const eventIdStr = dndPopup.dataset.eventId;
        const newDateStr = dndPopup.dataset.newDate;

        if (!eventIdStr || !newDateStr || !draggedElement || !currentDropZone) {
            console.error('Move Pre-condition failed. EventID:', eventIdStr, 'NewDate:', newDateStr, 'DE:', draggedElement, 'CDZ:', currentDropZone);
            dndPopup.style.display = 'none';
            clearDragState();
            return;
        }

        isOperationInProgress = true;
        dndPopup.style.display = 'none';
        console.log('Move button clicked. EventID:', eventIdStr, 'NewDate:', newDateStr);
        handleDropOperation("move", parseInt(eventIdStr), newDateStr, draggedElement, currentDropZone);
    });

    btnCopy.addEventListener('click', function() {
        if (isOperationInProgress) {
            console.log("Copy operation already in progress.");
            return;
        }
        const eventIdStr = dndPopup.dataset.eventId;
        const newDateStr = dndPopup.dataset.newDate;

        if (!eventIdStr || !newDateStr || !draggedElement || !currentDropZone) {
            console.error('Copy Pre-condition failed. EventID:', eventIdStr, 'NewDate:', newDateStr, 'DE:', draggedElement, 'CDZ:', currentDropZone);
            dndPopup.style.display = 'none';
            clearDragState();
            return;
        }
        isOperationInProgress = true;
        dndPopup.style.display = 'none';
        console.log('Copy button clicked. EventID:', eventIdStr, 'NewDate:', newDateStr);
        handleDropOperation("copy", parseInt(eventIdStr), newDateStr, draggedElement, currentDropZone);
    });

    btnCancel.addEventListener('click', function() {
        console.log('Cancel button clicked. isOperationInProgress:', isOperationInProgress);
        dndPopup.style.display = 'none';
        // If an operation was technically "in progress" (e.g. popup was visible),
        // but no async action (like fetch) has started, this is fine.
        // If fetch had started, it won't be aborted by this, but UI is reset.
        clearDragState();
    });

    async function handleDropOperation(operation, eventId, newDate, elementToProcess, targetDropZone) {
        console.log(`handleDropOperation: op=${operation}, eid=${eventId}, date=${newDate}. isOperationInProgress: ${isOperationInProgress}`);
        console.log('elementToProcess:', elementToProcess);
        console.log('targetDropZone:', targetDropZone);

        // Pre-condition check, though mostly handled by callers now
        if (!elementToProcess || !targetDropZone) {
             console.error("handleDropOperation critical error: elementToProcess or targetDropZone is null.");
             clearDragState();
             return;
        }

        try {
            const response = await fetch("{{ url_for('calendario.api_event_drop') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ event_id: eventId, new_date: newDate, operation: operation })
            });
            const data = await response.json();
            console.log('API Response Status:', response.status, 'API Data:', data);

            if (!isOperationInProgress && operation !== "cancel_after_fetch_started_scenario") {
                // This check is tricky. If user cancelled *while* fetch was ongoing.
                // For now, we assume if user cancelled, clearDragState already set isOperationInProgress to false.
                // And the DOM element (elementToProcess) might be out of sync or opacity restored.
                console.log("Operation was cancelled or finished before fetch completed. Aborting DOM update.");
                // Ensure element's opacity is restored if it's still the one we were dragging
                if (elementToProcess && elementToProcess.style.opacity !== '1') {
                     // elementToProcess.style.opacity = '1'; // This is now handled by clearDragState
                }
                return; // Don't proceed with DOM updates if operation flag was reset by cancel.
            }

            if (data.success) {
                if (operation === 'move') {
                    targetDropZone.appendChild(elementToProcess);
                    // Opacity is handled by clearDragState via finally
                } else if (operation === 'copy' && data.new_event_id) {
                    const clonedElement = elementToProcess.cloneNode(true);
                    clonedElement.dataset.eventId = data.new_event_id;
                    const editLink = clonedElement.querySelector('a.btn-custom-edit');
                    if (editLink) editLink.href = `{{ url_for('calendario.edit_event', event_id=0) }}`.replace('/0', '/' + data.new_event_id);
                    const detailsButton = clonedElement.querySelector('button.details-btn');
                    if (detailsButton) detailsButton.dataset.eventId = data.new_event_id;

                    targetDropZone.appendChild(clonedElement);
                    addDragEventListeners(clonedElement);
                    clonedElement.style.opacity = '1'; // Ensure clone is visible
                } else if (operation === 'copy' && !data.new_event_id) {
                     alert('エラー: コピー操作で新しいイベントIDが取得できませんでした。');
                     location.reload(); // Fallback for this specific error
                     return; // Important to return to avoid finally block double-clearing or errors
                }
                alert(data.message || '操作が完了しました。');
            } else {
                alert('エラー: ' + (data.error || '不明なエラーが発生しました。'));
                // If API call failed, restore opacity of the original dragged element
                if (elementToProcess) elementToProcess.style.opacity = '1';
            }
        } catch (error) {
            console.error('Error in handleDropOperation:', error);
            alert('通信エラーが発生しました。');
            if (elementToProcess) elementToProcess.style.opacity = '1';
        } finally {
            console.log('handleDropOperation finally block. Clearing state.');
            clearDragState();
        }
    }
});
</script>
{% endblock %}
